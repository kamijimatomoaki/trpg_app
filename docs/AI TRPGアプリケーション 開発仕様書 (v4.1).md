## **AI TRPGアプリケーション 開発仕様書 (v4.1)**

**更新履歴**

* v4.1 (2025/09/14): Vertex AIの呼び出し方法（Project ID, Location指定）と、使用モデル(Gemini 2.5 Flash)を明記。  
* v4.0 (2025/09/14): 開発着手のため、全項目を詳細化。エラーケース、AIエージェント設計、API詳細仕様を追加。

### **1\. 概要**

#### **1.1. プロジェクト名**

AIエージェントTRPG（仮称）

#### **1.2. コンセプト**

**「AIエージェント群が紡ぐ、仲間と挑む、あなただけの物語体験」**

複数の人間プレイヤーがリアルタイムに参加し、AIエージェントが務めるゲームマスター（GM）やノンプレイヤーキャラクター（NPC）と対話しながら、協力して物語を進めるマルチプレイヤーTRPGアプリケーション。「魔法の絵本」をモチーフとした没入感の高いUI/UXを通じて、これまでにない物語体験を提供する。

#### **1.3. ターゲットユーザー**

* TRPGに興味はあるが、一緒に遊ぶ仲間や時間を見つけるのが難しいと感じている人。  
* AIとの対話や、AIが生成するコンテンツに興味がある人。  
* 友人や仲間とオンラインで手軽に新しい協力型ゲームを体験したい人。

#### **1.4. プロジェクトゴール**

* Zennハッカソン「AI Agentが、現実を豊かにする」への提出と高評価の獲得。  
* Veo, Imagen, Geminiといった最新のAI技術と、マルチエージェントのコンセプトを組み合わせた、革新的なエンターテイメント体験の実証。  
* ユーザーが直感的に操作でき、繰り返し遊びたくなるような高いリプレイ性を持つアプリケーションのMVP（Minimum Viable Product）を開発する。

### **2\. 機能要件**

#### **2.1. ユーザーフロー全体像**

graph TD  
    A\[トップページ\] \--\>|部屋を作る| B(ロビー)  
    A \--\>|部屋に入る| B  
    B \--\>|ホストが開始| C(シナリオ投票)  
    C \--\>|多数決で決定| D(キャラクター作成)  
    D \--\>|作成完了| E(準備完了待機)  
    E \--\>|ホストが開始| F(オープニングムービー)  
    F \--\> G(ゲームプレイ)  
    G \--\>|物語の結末| H(リザルト画面)

1. **トップページ**: プレイヤーは新しいゲームを開始（部屋を作成）するか、既存のゲームに参加（部屋に入る）かを選択する。  
2. **ロビー**: 参加者が全員揃うのを待つ。ホストがゲームの準備を開始する。  
3. **シナリオ投票**: 参加者全員で、これからプレイする物語のテーマを投票で決定する。  
4. **キャラクター作成**: 決定したシナリオの世界観に沿って、プレイヤーは自身の分身となるキャラクターを作成する。  
5. **準備完了待機**: 全員がキャラクター作成を終え、ゲーム開始の準備が整うのを待つ。  
6. **オープニングムービー**: ゲームの導入となる動画が再生され、物語への没入感を高める。  
7. **ゲームプレイ**: AIゲームマスターと対話しながら、仲間と協力して物語を進めていく。  
8. **リザルト画面**: 物語が完結した後、冒険の軌跡を振り返る。

#### **2.2. 各機能詳細**

##### **2.2.1. ユーザー認証 (Firebase Authentication)**

* **要件**: ユーザーを安全かつシームレスに識別し、セッションを管理する。  
* **仕様**:  
  * アプリ初回アクセス時に**匿名認証**をバックグラウンドで実行し、ユーザーにユニークなuidを付与する。  
  * ユーザーはログイン操作を意識する必要はない。  
  * uidはFirestoreのプレイヤー識別子として使用し、ゲームへの復帰やデータ整合性の担保に利用する。

##### **2.2.2. トップページ**

* **UI要素**:  
  * \[部屋を作る\]ボタン  
  * 部屋ID入力フィールド (4-6桁の数字)  
  * \[部屋に入る\]ボタン  
* **ユーザーアクション**:  
  * \[部屋を作る\]をクリック: POST /games APIをコールし、成功したらレスポンスのgameIdを元にロビー画面へ遷移。  
  * 部屋IDを入力し\[部屋に入る\]をクリック: POST /games/{roomId}/join APIをコールし、成功したらロビー画面へ遷移。  
* **バックエンド処理**:  
  * 部屋作成: ユニークなroomIdを生成し、Firestoreに新しいgameドキュメントを作成。  
  * 部屋参加: 指定されたroomIdを持つgameドキュメントが存在するか確認し、プレイヤー情報を追加。  
* **エラーケース**:  
  * 部屋IDが存在しない場合: 「部屋が見つかりませんでした。」と表示。  
  * 部屋が満員の場合: 「この部屋は満員です。」と表示。  
  * ゲームが既に始まっている場合: 「このゲームは既に始まっています。」と表示。

##### **2.2.3. ロビー画面**

* **UI要素**:  
  * 部屋ID表示  
  * 参加プレイヤー一覧 (アバター、名前)  
  * \[冒険の準備を始める\]ボタン (ホストにのみ表示)  
  * \[部屋から退出する\]ボタン  
* **リアルタイム処理**:  
  * FirestoreのonSnapshotを利用し、プレイヤーの入退室をリアルタイムで画面に反映する。  
* **ユーザーアクション**:  
  * ホストが\[冒険の準備を始める\]をクリック: POST /games/{gameId}/start-voting APIをコールし、全プレイヤーをシナリオ投票画面へ遷移させる。

##### **2.2.4. シナリオ投票画面**

* **UI要素**:  
  * 浮遊する3つの「夢のオーブ」（シナリオ候補）。  
  * オーブにはシナリオタイトルが表示。マウスオーバーであらすじを表示。  
  * 各オーブの周囲に、投票したプレイヤーのアバターが表示されるエリア。  
* **リアルタイム処理**:  
  * 各プレイヤーの投票状況をリアルタイムで全画面に反映する。  
* **ユーザーアクション**:  
  * オーブを1つクリックして投票する。POST /games/{gameId}/vote APIをコール。  
* **バックエンド処理**:  
  * start-votingリクエスト時: Geminiをコールしてシナリオ案を3つ生成し、Firestoreを更新。  
  * voteリクエスト時: Firestoreの投票情報を更新。全プレイヤーの投票が完了したら、多数決でシナリオを決定し、gameStatusをcreating\_charに更新。同時にVeoへの動画生成リクエストを非同期で開始。

##### **2.2.5. キャラクター作成画面**

* **UI要素**:  
  * キャラクター名入力フィールド。  
  * キャラクターの特徴入力テキストエリア。  
  * **TRPG能力値設定エリア**:
    * 6つの基本能力値（筋力、敏捷、知力、体力、精神、魅力）表示カード
    * 各能力値の3D6サイコロ振りアニメーション
    * \[サイコロを振る\]ボタン（全能力値一括）
    * \[個別に振り直し\]ボタン（各能力値）
    * 能力値の合計値とボーナス計算の自動表示
  * \[キャラクターを生成する\]ボタン。  
  * 生成された画像表示エリア。  
  * \[これで決定\]ボタン。  
* **能力値システム仕様**:
  * **基本能力値**: 筋力(STR)、敏捷(DEX)、知力(INT)、体力(CON)、精神(WIS)、魅力(CHA)
  * **ダイス**: 各能力値は3D6（3つの6面サイコロ）で決定（3-18の範囲）
  * **アニメーション**: サイコロが回転しながら結果を表示する3Dアニメーション
  * **ボーナス計算**: 能力値に基づく修正値を自動計算（例：15→+2、10→±0、8→-1）
  * **バランス調整**: 合計値が極端に低い場合の振り直し推奨機能
* **ユーザーアクション**:  
  * キャラクター作成開始時に能力値サイコロを自動で1回振る
  * プレイヤーは個別または全体の振り直しが可能
  * 名前と特徴を入力し\[キャラクターを生成する\]をクリック: バックエンドにImagenでの画像生成をリクエスト。ローディング表示。  
  * 生成された画像を確認し\[これで決定\]をクリック: POST /games/{gameId}/create-character APIをコールし、準備完了待機画面へ遷移。  
* **バックエンド処理**:  
  * Imagenをコールし、生成された画像のURLを返す。  
  * create-characterリクエスト時: Firestoreにキャラクター情報（能力値含む）を保存。

##### **2.2.6. 準備完了待機画面**

* **UI要素**:  
  * 参加者全員のキャラクター画像、名前、「準備中... / 準備完了」ステータス一覧。  
  * \[準備完了\]ボタン (各プレイヤー)。  
  * \[ゲームを開始する\]ボタン (ホストのみ、デフォルトは無効)。  
* **リアルタイム処理**:  
  * 各プレイヤーのisReadyステータスをリアルタイムで反映。  
  * オープニング動画のstatusを監視。  
  * 両方の条件が満たされたら、ホストの開始ボタンを有効化する。  
* **ユーザーアクション**:  
  * \[準備完了\]をクリック: POST /games/{gameId}/ready APIをコール。  
  * ホストが\[ゲームを開始する\]をクリック: POST /games/{gameId}/start-game APIをコール。

##### **2.2.7. ゲームプレイ画面**

* **UI**: 「魔法の絵本」の見開きページ。左に画像、右にテキストログ。  
* **ターン進行ロジック**:  
  1. GMが状況を説明（gm\_narration）。  
  2. 全プレイヤーの行動入力が可能になる。  
  3. 各プレイヤーが行動を送信 (POST /games/{gameId}/action)。Firestoreにはplayer\_actionとしてログが追加され、UIに即時反映。  
  4. バックエンドは全プレイヤーの行動が揃ったことを検知する。  
  5. 全プレイヤーの行動をまとめてGMエージェントに渡し、次の展開を生成させる。  
  6. 生成された結果（ナレーション、画像プロンプト等）をFirestoreに保存。  
  7. UIがFirestoreの更新を検知し、ページめくりアニメーションと共に新しい状況を表示。  
* **タイムアウト処理 (MVPでは対象外)**: 一定時間行動しないプレイヤーがいた場合、自動でターンをスキップするなどの処理も将来的には検討。

### **3\. AIエージェント設計**

#### **3.1. GMエージェント (Gemini 2.5 Flash)**

* **役割**: 物語全体の進行管理、ルール判定、世界の状況描写、プレイヤーの行動解釈、画像生成プロンプトの作成を担当する司令塔。  
* **パーソナリティ**: 物語を面白くしようと務める、創造的で公平な語り部。プレイヤーの意図を汲み取り、多少の無茶な行動にも柔軟に対応する。  
* **コアプロンプト (システムプロンプト) 設計**:  
  * **役割定義**: 「あなたはTRPGの熟練ゲームマスターです。」  
  * **世界観設定**: 選択されたシナリオの基本設定（時代、場所、雰囲気など）。  
  * **ルール**: プレイヤーは複数人いること。全員の行動を考慮して物語を進めること。暴力的な表現や不適切な内容は避けること。  
  * **出力形式**: 常にJSON形式で応答すること。必須キーは narration (string), imagePrompt (string | null)。  
* **入力情報**:  
  * コアプロンプト  
  * これまでのゲームログ (gameLog)  
  * 現在のターンにおける全プレイヤーの行動テキスト

#### **3.2. マルチエージェントのコンセプト**

本プロジェクトでは、GMエージェントが司令塔となり、必要に応じて専門的なタスク（動画生成、画像生成）を行う\*\*ツールエージェント (Veo/Imagen)\*\*を呼び出す構成を取る。これにより、単一のAIでは実現困難な、豊かで複合的なコンテンツ生成を実現する。

### **4\. 技術仕様**

#### **4.1. アーキテクチャ図**

(変更なし)

#### **4.2. データベーススキーマ (Firestore)**

* gamesコレクション ドキュメント:  
  interface Game {  
    id: string; // Document ID  
    roomId: string; // ユーザー向けの部屋ID  
    hostId: string; // ホストのUID  
    gameStatus: 'lobby' | 'voting' | 'creating\_char' | 'ready\_to\_start' | 'playing' | 'finished';  
    createdAt: FieldValue; // 作成日時  
    // プレイヤー情報  
    players: {  
      \[uid: string\]: {  
        name: string; // キャラクター名ではない、プレイヤー名（今回はuidで代用）  
        characterName: string | null;  
        characterDescription: string | null;  
        characterImageUrl: string | null;  
        isReady: boolean; // 準備完了待機画面でのステータス  
        joinedAt: FieldValue;  
      };  
    };  
    // シナリオ投票関連  
    scenarioOptions?: { id: string; title: string; summary: string; }\[\];  
    votes?: { \[scenarioId: string\]: string\[\]; };  
    decidedScenarioId?: string;  
    // ビデオ生成関連  
    openingVideo?: {  
      status: 'generating' | 'ready' | 'error';  
      url: string | null;  
      prompt: string;  
    };  
    // ゲーム本編ログ  
    gameLog?: {  
      turn: number;  
      type: 'gm\_narration' | 'player\_action' | 'image\_generation';  
      content: string; // ナレーション or プレイヤーの行動テキスト  
      imageUrl?: string; // 生成された画像のURL  
      playerId?: string; // player\_actionの場合のuid  
      timestamp: FieldValue;  
    }\[\];  
    currentTurn: number;  
    playerActionsThisTurn?: {  
      \[uid: string\]: string; // 今ターンのプレイヤーの行動テキスト  
    }  
  }

#### **4.3. APIエンドポイント詳細 (FastAPI)**

* POST /games  
  * **説明:** 新規ゲームセッション作成  
  * **Request Body:** {}  
  * **Success (200):** { "gameId": "...", "roomId": "..." }  
  * **Error (500):** { "detail": "Failed to create game session." }  
* POST /games/{roomId}/join  
  * **説明:** 既存セッションへの参加  
  * **Request Body:** {}  
  * **Success (200):** { "gameId": "..." }  
  * **Error (404):** { "detail": "Room not found." }  
  * **Error (403):** { "detail": "Room is full or game has already started." }  
* ... (他のエンドポイントも同様に、リクエスト/レスポンス/エラーを詳細に定義)

#### **4.4. セキュリティ**

* **Firestoreセキュリティルール**:  
  * gamesドキュメントは、playersフィールドに含まれるuidを持つ認証済みユーザーのみが読み書きできるように設定する。  
  * ゲーム状態の重要な変更（例: gameStatusの更新）は、ホスト(hostId) のみ、またはバックエンドからのリクエストのみ許可するなど、厳格なルールを定義する。  
* **バックエンド**: 全てのリクエストでFirebase AuthのIDトークンを検証し、リクエスト元ユーザーのuidを正しく識別・認可する。

#### **4.5. AI連携 (Vertex AI)**

* **プラットフォーム**: Google Cloud Vertex AI  
* **SDK**: バックエンドは公式のGoogle Cloud Vertex AI SDK for Pythonを利用して各AIモデルと連携する。  
* **認証と設定**:  
  * Vertex AIへのAPIコールは、Cloud Run環境に設定されたサービスアカウントを介して認証される。  
  * SDKの初期化時に、環境変数からPROJECT\_IDとLOCATION（例: asia-northeast1）を読み込んで指定する。  
* **使用モデル**:  
  * **テキスト生成 (GMエージェント)**: gemini-2.5-flash  
  * **動画生成**: Veo  
  * **画像生成**: Imagen

### **5\. 開発計画**

| フェーズ | 主要タスク | 完了の定義 (Definition of Done) |
| :---- | :---- | :---- |
| **Day 1** | **基盤構築** | \- 匿名認証でuidが取得できる。\<br\>- 部屋を作成し、発行されたroomIdで他のユーザーが入室できる。\<br\>- ロビー画面で参加者の入退室がリアルタイムに表示される。 |
| **Day 2** | **コアフロー実装** | \- ホストが開始すると、全プレイヤーがシナリオ投票画面に遷移する。\<br\>- 投票が完了し、シナリオが決定される。\<br\>- 各プレイヤーがキャラクター名を決め、Imagenで画像が生成できる。\<br\>- 全員が準備完了を押せる。 |
| **Day 3** | **演出強化と仕上げ** | \- Veoで動画が生成され、準備完了後にホストの開始ボタンが有効化される。\<br\>- ゲーム開始後、ターン制でGMとの対話が最低1ターン以上成立する。\<br\>- 全体のフローがエラーなく通しでプレイできる。 |

