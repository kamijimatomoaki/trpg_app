---
title: "GeminiとFirestoreを用いたリアルタイム・マルチモーダルTRPG Agentの開発"
emoji: "🛠️"
type: "tech"
topics: ["AI", "Gemini", "Firestore", "FastAPI", "React", "ハッカソン", "Agent"]
published: false
---

## はじめに

Google Cloud Japan AI Hackathon vol.3に参加し、「AI TRPG Agent」というWebアプリケーションを開発しました。本稿では、そのシステム構成と、開発で中心的な役割を果たした技術について解説します。

### 対象ユーザーと課題

本プロジェクトでは、以下のユーザー像を想定しています。

- TRPG（テーブルトークRPG）に興味はあるが、一緒に遊ぶ仲間や時間を見つけるのが難しい人。
- ゲームマスター（GM）の準備や進行の負荷が高く、気軽に開催できないと感じている経験者。

TRPGの魅力は、参加者全員で協力して物語を創り上げる「共創体験」にありますが、その体験には「GMの高い専門性」と「参加者間のスケジュール調整」という2つの大きなハードルが存在します。

### 解決策と本プロジェクトの特徴

上記の課題に対し、我々は「**AIをGMとし、Web上でリアルタイムマルチプレイを可能にすること**」をソリューションとして提案します。これにより、GMの負荷をなくし、誰もがいつでも気軽にTRPGの共創体験を得られる環境を目指しました。

本プロジェクトの主な特徴は以下の3点です。

1.  **自律的なAI Agent**: GeminiのFunction Callingを活用し、AIがゲームルールを理解・実行します。
2.  **リアルタイム・マルチプレイヤー**: Firestoreを用い、複数人での同時プレイと状態同期を実現します。
3.  **マルチモーダルな体験**: Imagenによる画像生成を組み込み、テキストとビジュアルで物語への没入感を高めます。

以降では、これらの特徴を実現するためのシステムアーキテクチャと、採用した主要技術について詳述します。

## システムアーキテクチャ

開発したシステムのアーキテクチャは以下の通りです。フロントエンドとバックエンドを分離し、状態同期をFirebase Firestoreに集約させる構成としました。

- **フロントエンド**: React (TypeScript), Vite, Firebase Hosting
- **バックエンド**: Python, FastAPI, Cloud Run
- **データベース / リアルタイム通信**: Firebase Firestore
- **AI**: Vertex AI (Gemini 2.5 Pro, Imagen, Veo)

バックエンドはステートレスなAPIとして設計し、ゲームの永続的な状態はすべてFirestoreに保持します。プレイヤーのアクションはFastAPI経由で受け付け、AIによる処理を行った後、結果をFirestoreに書き込みます。フロントエンドはFirestoreの変更をリアルタイムに購読し、UIを更新する責務を負います。

## 主要技術と選択理由

### 1. AI Agentの自律性：Gemini と Function Calling

ゲームマスターとしてのAIの自律性を実現するため、Vertex AIのGemini 2.5 ProとFunction Callingを採用しました。

TRPGでは、「ダイスを振る」「ステータスを確認する」といった、物語の進行とは別のルールベースの処理が頻繁に発生します。当初はプレイヤーの入力テキストを正規表現などで解析することも検討しましたが、表現の揺れに対応しきれないという課題がありました。

Function Callingを用いることで、これらのルール処理をPythonの関数として定義し、その説明を自然言語でGeminiに提供するだけで、AI自身が対話の文脈から適切なタイミングで関数を呼び出すことが可能になりました。例えば、「ダイスを振って」というプレイヤーの発言に対し、Geminiが自律的に`roll_dice`関数を呼び出す、といった挙動が実現できます。これにより、バックエンドの実装を大幅に簡素化しつつ、柔軟なユーザー入力に対応できました。

### 2. リアルタイム性の実現：Firebase Firestore

複数プレイヤー間でのリアルタイムな状態同期には、Firestoreを選択しました。主な理由は、そのリアルタイムリスナー（`onSnapshot`）機能と、開発の容易さです。

WebSocketを用いたカスタム実装も選択肢にありましたが、ハッカソンという限られた開発期間を考慮すると、認証やスケーラビリティ、再接続処理などを自前で実装するコストは大きいと判断しました。Firestoreを利用することで、クライアント側で数行のコードを記述するだけで、データベースの変更をリアルタイムにUIへ反映させることができました。

結果として、プレイヤーの参加、投票、チャットといったインタラクションが、ストレスなく全参加者の画面で同期される体験を、短期間で実現することができました。

### 3. マルチモーダルへの挑戦：Imagen と Veo

表現の幅を広げる試みとして、画像生成AIのImagenと動画生成AIのVeoの組み込みも行いました。

Imagenは、Geminiが生成した物語の情景を説明するプロンプトを受け取り、挿絵を生成する役割を担います。これにより、テキストだけでは伝えきれない雰囲気を視覚的に補強する効果が得られました。

Veoについては、ゲームのオープニング動画を動的に生成する機能の実装に挑戦しました。バックエンドのコードは完成したものの、ハッカソン期間中に割り当てられたAPIのQuotaが不足しており、実際にAPIを呼び出して動作させるまでには至りませんでした。これは今後の課題となります。

## まとめと今後の課題

本プロジェクトでは、GeminiのFunction CallingとFirestoreのリアルタイム機能を組み合わせることで、AIが自律的にルールを処理し、かつ複数人がリアルタイムで参加できるTRPGアプリケーションのプロトタイプを開発しました。

今後の技術的な課題としては、以下の点が挙げられます。

- **Veoの組み込み**: Quotaの問題をクリアし、動画生成機能を完全に動作させること。
- **Function Callingの拡充**: ダイスロールだけでなく、より複雑なゲームルールの判定（例：戦闘処理、アイテムの効果判定など）をツールとして追加していくこと。
- **AIの長期記憶**: ゲームログが長くなった際の、AIのコンテキスト維持と一貫性の担保。

本稿が、同様のリアルタイムAIアプリケーションを開発する際の参考となれば幸いです。

## 感想

個人的な技術的所感として、Firestoreの便利さを改めて実感しました。以前、第2回のハッカソン出場した際にWebSocketを用いたリアルタイム通信の実装を試みた際、その実装難易度の高さに苦戦した経験がありましたが、今回はFirestoreを採用したことで、リアルタイム性が求められるアプリケーション開発の生産性が大幅に向上することを体験できました。

今回、目標としていたコア機能（AI Agentとリアルタイムマルチプレイ）実装を期間内に完成させることができ、大きな達成感を得られました。
このような貴重な機会を提供してくださった運営の皆様に、心より感謝申し上げます。
